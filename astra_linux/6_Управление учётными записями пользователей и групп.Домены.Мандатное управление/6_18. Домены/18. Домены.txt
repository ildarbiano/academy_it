Домены

План урока
Настройка домена ALD и DNS-сервера.
Настройка внутреннего DNS-сервера с помощью программного обеспечения сервера имен BIND (BIND9).
ALD.
Настройка сервера ALD.
Использование команд и графических утилит для администрирования доменных учётных записей ALD-сервера.
Сервис Kerberos.
Практическое задание.


===================== Настройка домена ALD и DNS-сервера ===========================================================
ALD		(Astra Linux Directory) 	- cлужба операционной системы Astra Linux Special Edition — это система управления единым пользовательским пространством. В терминах, привычных пользователям Windows, Astra Linux Directory — это домен. Astra Linux Directory выполняет следующие основные функции:
ALD		хранит базы данных учётных записей пользователей;
ALD		обеспечивает единую аутентификацию и авторизацию для пользователей;
ALD		предоставляет сетевые домашние каталоги пользователей;
ALD		управляет пользователями, службами, мандатными атрибутами.
Важный элемент управления конфигурацией и инфраструктурой сервера — поддержание удобного способа просмотра сетевых интерфейсов и IP-адресов по имени с помощью настройки корректной системы доменных имён (DNS). 
DNS		(Domain Name System) 		— это система доменных имён, которая позволяет сопоставлять домены сайтов с IP-адресами, необходимыми для подключения устройств к серверам в сети. Использование полных доменных имен (FQDN) для указания сетевых адресов облегчает настройку служб и приложений и улучшает поддерживаемость файлов конфигурации. Настройка собственной DNS для вашей частной сети — это отличный способ совершенствования методов управления серверами.


===================== Настройка внутреннего DNS-сервера с помощью программного обеспечения сервера имен BIND (BIND9) =
BIND 							(Berkeley Internet Name Daemon) в качестве сервера DNS 
Настройка производится на DNS-сервере (например, srv1.test.ru).
sudo apt-get install bind9 bind9utils bind9-doc		Установить bind9
/etc/bind/db.test 					создать конфигурационный файл 
/etc/bind/db.192.168.1 					создать файл описания подсети
mcedit /etc/bind/db.test				отредактировать конфигурационный файл, он должен содержать следующие данные:
	$TTL 604800
	@ IN SOA srv1.test.ru. root.test.ru. (
	20110913 ; Serial
	604800 ; Refresh
	86400 ; Retry
	2419200 ; Expire
	604800 ) ; Negative Cache TTL
	IN NS srv1
	srv1            IN A 192.168.1.1
	@               IN              MX      10      srv1
	srvN            IN A 192.168.1.N
	vm01           IN              A               192.168.1.101
	vm02           IN              A               192.168.1.102
	vm03           IN              A               192.168.1.103
	vmM            IN              A               192.168.1.1M
mcedit /etc/bind/db.192.168.1				отредактировать конфигурационный файл, он должен содержать следующие данные:
	$TTL 604800
	@ IN SOA srv1.test.ru. root.test.ru. (
	2011091301 ; Serial
	604800 ; Refresh
	86400 ; Retry
	2419200 ; Expire
	604800 ) ; Negative Cache TTL
		IN NS srv1.test.ru.
	1 IN PTR srv1.test.ru.				сервер
	...
	N IN PTR srvN.test.ru.
	101 IN PTR vm01.test.ru.			арм
	...
	1M IN PTR vmM.test.ru.
где: 
N 	– количество серверов, 
M 	– количество АРМ;

mcedit /etc/bind/named.conf.local			отредактировать конфигурационный файл, файл конфигурации локального DNS-сервера. В нём объявляются зоны, за которые отвечает данный сервер, и задаются настройки для них. он должен содержать следующие данные:
	zone "test.ru" {
	type master;
	file "/etc/bind/db.test";
	};
	zone "1.168.192.in-addr.arpa" {
	type master;
	file "/etc/bind/db.192.168.1";
	};

mcedit /etc/bind/db.root				отредактировать конфигурационный файл, файл с описанием корневых серверов имён. он должен содержать только следующие данные:
	. 3600000 IN NS A.ROOT-SERVERS.NET.
	A.ROOT-SERVERS.NET. 3600000 A 192.168.1.1

/etc/bind/named.conf.options				отредактировать конфигурационный файл с глобальными параметрами конфигурации. является частью основного конфигурационного файла сервера — /etc/bind/named.conf, он должен содержать только следующие данные:
	acl "corpnet" {192.168.1.0/24; 127.0.0.1;};
	options {
	directory "/var/cache/bind";
	auth-nxdomain no;
	listen-on-v6 { any; };
	allow-query {"corpnet";};
	};

/etc/resolv.conf					отредактировать конфигурационный файл (на каждом компьютере, который будет входить и подключаться к dns-серверу), используемый в UNIX-подобных системах, где указываются параметры для разрешения DNS. он должен содержать следующие данные:
	search test.ru
	nameserver 192.168.1.1

/etc/hosts 						отредактировать конфигурационный файл для, первого сервера, настроить соответствие между доменом и конкретным IP-адресом, он имеет следующие шаблон:
	127.0.0.1 	localhost.localdomain 	localhost
	192.168.0.N 	srvN.test.ru 		srvN
например он должен содержать следующие данные:
	127.0.0.1 	localhost.localdomain 	localhost
	192.168.0.1 	srv1.test.ru		srv1

/etc/parsec/privsock.conf 				!!! при работе с мандатным уровнем доступа, нужно убедиться, что наш сервер внесён в parsec. PARSEC реализует функции мандатного контроля доступом (МКД) и мандатного контроля целостности (МКЦ). Иначе, при заходе пользователя под метками, не будет возможность определить имя сервера. Убедиться, что в файле содержится строка /usr/sbin/named и в файле ....
/etc/default/bind9 					Убедиться, что в файле была строка PATH=/usr/lib/parsec/bin:$PATH содержащая строка, ссылка на путь, для отработки МКД и МКЦ.
hostnamectl set-hostname srv1.test.ru			так как был заменено в /etc/hosts имя сервера, то необходимо изменить имя машины.
bash							чтобы изменилось имя машины./etc/hosts
sudo systemctl restart bind9				перезапустить демон Bind
nslookup srv1						удостоверится в корректной работе сервиса DNS командой, при этом во FLY-терминале должна будет выдана информация о полном имени srv1.test.ru и его IP-адресе.

/etc/resolv.conf 					Важно! На клиентских машинах после настройки DNS-сервера не забываем править например:
	search test.ru
	nameserver
	nameserver
	(если пользуемся networking) и указывать DNS-сервера в nmtui (если пользуемся NetworkManager).
NPT				для корректной работы ALD-сервера необходим сервер точного времени (NPT). 
NPT				сервер точного времени - это сервер, который предоставляет точную и синхронизированную информацию о текущем времени. Он используется для синхронизации часов на компьютерах и других устройствах в компьютерных сетях.
Сделаем настройку на сервере ALD (srv1.test.ru) :
/etc/ntp.conf 			отредактировать конфигурационный файл сервера, он должен содержать следующие данные:
     driftfile /var/lib/ntp/ntp.drift
     statsdir /var/log/ntpstats/
     statistics loopstats peerstats clockstats
     filegen loopstats file loopstats type day enable
     filegen peerstats file peerstats type day enable
     filegen clockstats file clockstats type day enable
     server 127.127.1.0 
     fudge 127.127.1.0 stratum 0
     restrict -4 default kod notrap nomodify nopeer noquery
     restrict -6 default kod notrap nomodify nopeer noquery
     restrict 127.0.0.1
     restrict ::1
     restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap
sudo systemctl enable ntp	добавим сервис NTP в автозагрузку.
sudo systemctl restart ntp	запустить демон NTP.


============== Настройка сервера ALD ====================================================================
ALD 		(Astra Linux Directory) 	— это Служба, система управления Единым пространством пользователей и надстройка над технологиями LDAP, Kerberos 5, CIFS, которая автоматически настраивает все необходимые конфигурационные файлы служб, реализующих перечисленные технологии, а также предоставляет интерфейс управления и администрирования.
LDAP 	(Lightweight Directory Access Protocol)	— это протокол доступа к каталогам, который используется для управления и доступа к информации в распределённых каталогах.
Каталог 					—  это структурированное хранилище данных, которое содержит информацию о пользователях, группах, ресурсах и других объектах в компьютерной сети.
LDAP						- обеспечивает стандартизированный способ поиска, добавления, изменения и удаления записей в каталоге. Он использует клиент-серверную модель, где клиент отправляет запросы на сервер LDAP, а сервер отвечает на эти запросы с соответствующей информацией из каталога.
Kerberos 5					— это протокол аутентификации сети, который обеспечивает безопасность при передаче информации между клиентом и сервером. Он используется для проверки подлинности пользователей и предоставления им доступа к ресурсам в распределённой сети. Протокол Kerberos 5 работает на основе выдачи «билетов» (tickets), которые используются для аутентификации пользователя. Когда пользователь успешно проходит аутентификацию, ему выдается «билет», который он может использовать для доступа к различным ресурсам в сети. «Билеты» шифруются, чтобы обеспечить безопасность передачи информации. Kerberos 5 также предоставляет механизмы для защиты от атак, таких как подделка билетов или повторное использование старых билетов. Для обмена ключами и обеспечения безопасности он использует симметричное шифрование.
Настройка сервера ALD. Установим службу ALD и дополнительные пакеты к нему: 
sudo apt install fly-admin-ald-server ald-server-common smolensk-security-ald ald-client-common fly-admin-ald-client	
	smolensk-security-ald 			Пакет, необходим для ALD для управления мандатными привилегиями в Astra Linux Special Edition. 
	ald-server-common			Если без мандатных привилегий, то достаточно пакета.
	fly-admin-ald-server			это графические пакеты управления сервером.
	fly-admin-ald-client			это графические пакеты управления клиентом.
/etc/ald/ald.conf 				Сконфигурируем сервер ald, укажем в файле конфигурацииследующие параметры:
	DOMAIN=.test.ru
	SERVER=srv1.test.ru
	TICKET_MAX_LIFE=7d
	TICKET_MAX_RENEWABLE_LIFE=14d
	SERVER_ON=1
	CLIENT_ON=1
ald-init init				инициализировать домен; согласимся с перенастройкой параметров домена; дважды введем главный пароль к БД Kerberos и пароль администратора домена ALD. Данную операцию желательно проводить не удалённо, а непосредственно на сервере домена, так как для генерации ключей домена может потребоваться переместить манипулятор типа «мышь», чтобы обеспечить датчик случайных чисел нужными входными данными. Удалённый запуск данной процедуры может завершиться по таймауту (5 мин.). домен создан, далее необходимо:
fly-admin-ald-server			зайти в настройку домена.
5)	Соединиться с доменом, нажав на пиктограмму подключения, и ввести пароль администратора домена ALD.
6)	Ввести необходимые машины в домен, создать учетные записи пользователей, мандатный контекст.
7)	Убедиться, что у всех принципалов (учётных записей) домена время жизни билета kerberos установлено в пять дней, для этого выполним команду
for i in `kadmin -p admin/admin -w пароль_домена -q "listprincs"`; do kadmin -p admin/admin -w пароль_домена -q "getprinc $i" |egrep &apos;Principal| life&apos;;done
8)	Если в результате выполнения данной команды на экран выводится хотя бы одно значение параметра «Maximum ticket life:», отличное от значения «5 days», то необходимо выполнить команду по смене максимального времени жизни билета Kerberos
for i in `kadmin -p admin/admin -w пароль_домена -q "listprincs"`; do kadmin -p admin/admin -w пароль_домена -q "modprinc -maxlife 5days $i";done
9)	На всех серверах рекомендуется увеличить ограничение по количеству открытых файлов. Для этого в файле /etc/security/limits.conf изменим параметры
soft nofile 2048 hard nofile 4096


============= Использование команд и графических утилит для администрирования доменных учётных записей A ==========================
fly-admin-ald-server			Администрирование доменных учётных записей производится через утилиту. Её можно запустить через консоль, либо в панели управления, перейдя на вкладку «Безопасность» и запустив аплет «Политика безопасности». Первым делом необходимо настроить политику паролей в соответствии с вашими требованиями.


============= Сервис Kerberos ======================================================================================================
Kerberos 				Сервис в Astra Linux позволяет настраивать систему аутентификации пользователей и сервисов. 
Kerberos 				обеспечивает централизованное управление учётными записями и паролями, что упрощает администрирование системы.
Команды администрирования:
-------------------------- 1. Создание принципала ----------------------------------------
Принципал 				— это учётная запись Kerberos.
sudo kadmin.local -q "addprinc имя_принципала"		команда kadmin.local для создания нового принципала.
-------------------------- 2. Изменение пароля принципала --------------------------------
sudo kadmin.local -q "change_password имя_принципала"	команда kadmin.local для изменения пароля принципала.
-------------------------- 3. Удаление принципала ----------------------------------------
sudo kadmin.local -q "delete_principal имя_принципала"	для удаления принципала.
Администрирование Kerberos в Astra Linux позволяет создавать, удалять и управлять принципалами, настраивать файлы конфигурации и базу данных, а также контролировать доступ к ресурсам. Примеры использования Kerberos в Astra Linux:
1. Аутентификация пользователей.
Kerberos 				позволяет централизованно управлять учётными записями и аутентифицировать пользователей на любой машине в сети.  Это безопасно и удобно.  
2. Аутентификация сервисов
Kerberos 				позволяет аутентифицировать сервисы и обеспечивать безопасный доступ к ресурсам. Например, веб-сервер может получить доступ к зашифрованным данным, используя ключ, полученный от Kerberos.
3. Удалённое управление.
Kerberos				позволяет аутентифицировать удалённых пользователей или администраторов и предоставлять доступ к удалённому управлению.
4. Шифрование трафика.
Kerberos 				шифрует трафик между клиентом и сервером с использованием различных ключей и методов шифрования.
Чтобы поменять пароль ALD-администратора admin/admin выполните следующие команды:
kadmin.local  
listprincs  
change_password admin/admin@домен.ru



============================================
