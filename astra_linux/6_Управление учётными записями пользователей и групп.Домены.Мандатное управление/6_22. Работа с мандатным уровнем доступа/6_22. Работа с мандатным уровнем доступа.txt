Работа с мандатным уровнем доступа
Мандатный контроль доступом		МКД	доступ к данным
Мандатный контроль целостности		МКЦ	гарантирует неизменность данных
https://wiki.astralinux.ru/pages/viewpage.action?pageId=153486002

План урока
Файлообменный сервер с различным мандатным уровнем доступа.
Настройка файлового сервера.
Настройка автоматического подключения к файловому сервису.
Инструменты резервного копирования.
Инструмент командной строки dd.
Инструмент командной строки tar.
Инструмент командной строки rsync.
Запуск служб на мандатном уровне доступа.
Переопределение мандатных уровней доступа пользователей и пользовательских каталогов.

================== Файлообменный сервер с различным мандатным уровнем доступа =====================================================================================
Перед настройкой файлового сервера определяется политика мандатного разграничения в Едином Пространстве Пользователей (ЕПП) и создаётся структура его каталогов. Для мандатного разграничения доступа необходимо определиться со следующими настройками ЕПП:
	максимальным уровнем доступа:  
		НС — несекретно (0),
		ДСП — для служебного пользования (1),
		С — секретно (2),
		СС — совершенно секретно (3). максимальный уровень доступа — 3;
	максимальным уровнем целостности
		максимальный уровень целостности равен нулю (0);
	максимальной категорией.
В примере, который мы рассмотрим, учитываются следующие настройки ЕПП. В структуре каталогов у каждого пользователя на каждом уровне есть своя персональная папка, в которую другие пользователи записывают документы, но прочитать её не имеют права. Чтобы повысить уровень документа, его нужно записать в папку «Общая» на уровнях отличных от нулевого уровня.Рассмотрим структуру каталогов:
/
|-/DATA
|  |-samba
|  |  |-НС
|  |  |  |-user1
|  |  |  |-user2
|  |  |
|  |  |-ДСП
|  |  |  |-user1
|  |  |  |-user2
|  |  |  |-общая
|  |  |
|  |  |-С
|  |  |  |-user1
|  |  |  |-user2
|  |  |  |-общая
|  |  |
|  |  |-СС
|  |  |  |-user1
|  |  |  |-user2
|  |  |  |-общая


================== Настройка файлового сервера ==============================================================
Для создания структуры каталогов выполним команды:
mkdir -p /DATA/samba
mkdir /DATA/samba/НС/
mkdir /DATA/samba/НС/user1
chown user1 /DATA/samba/НС/user1
chmod 733 /DATA/samba/НС/user1
mkdir /DATA/samba/НС/user2
chown user2 /DATA/samba/НС/user2
chmod 733 /DATA/samba/НС/user2
mkdir /DATA/samba/НС/общая
chmod 777 /DATA/samba/НС/общая
mkdir /DATA/samba/ДСП/
mkdir /DATA/samba/ДСП/user1
chown user1 /DATA/samba/ДСП/user1
chmod 733 /DATA/samba/ДСП/user1
mkdir /DATA/samba/ДСП/user2
chown user2 /DATA/samba/ДСП/user2
chmod 733 /DATA/samba/ДСП/user2
mkdir /DATA/samba/ДСП/общая
chmod 777 /DATA/samba/ДСП/общая
mkdir /DATA/samba/С/
mkdir /DATA/samba/С/user1
chown user1 /DATA/samba/С/user1
chmod 733 /DATA/samba/С/user1
mkdir /DATA/samba/С/user2
chown user2 /DATA/samba/С/user2
chmod 733 /DATA/samba/С/user2
mkdir /DATA/samba/С/общая
chmod 777 /DATA/samba/С/общая
mkdir /DATA/samba/СС/
mkdir /DATA/samba/СС/user1
chown user1 /DATA/samba/СС/user1
chmod 733 /DATA/samba/СС/user1
mkdir /DATA/samba/СС/user2
chown user2 /DATA/samba/СС/user2
chmod 733 /DATA/samba/СС/user2
mkdir /DATA/samba/СС/общая
chmod 777 /DATA/samba/СС/общая
pdp-flbl 3:0:0:ccnr /DATA/
pdp-flbl 3:0:0:ccnr /DATA/samba/
pdp-flbl 0:0:0 /DATA/samba/НС/
pdp-flbl 0:0:0 /DATA/samba/НС/*
pdp-flbl 1:0:0:ccnr /DATA/samba/ДСП/
pdp-flbl 1:0:0 /DATA/samba/ДСП/*
pdp-flbl 1:0:0 /DATA/samba/ДСП/
pdp-flbl 2:0:0:ccnr /DATA/samba/С/
pdp-flbl 2:0:0 /DATA/samba/С/*
pdp-flbl 2:0:0 /DATA/samba/С/
pdp-flbl 3:0:0:ccnr /DATA/samba/СС/
pdp-flbl 3:0:0 /DATA/samba/СС/*
pdp-flbl 3:0:0 /DATA/samba/СС/
------------------------------
После создания структуры каталогов в конфигурационный файл /etc/samba/smb.conf добавим следующие строки:
На сервере ALD домена добавим блок:
    [shared]
	available = yes
	comment = Share for users
	browseable = yes
	case sensitive = yes
	read only = no
	guest ok = yes
	ea support = yes
	fstype = Samba
	hide dot files = no
	locking = yes
	path = /DATA/samba
	writable = yes
	smb encrypt = auto
	wide links = yes
	create mask = 0660
	force create mode = 0660
	directory mask = 0770
	force directory mode = 0770
	write list = @group_1,@group_3,@group_4
Конфиг SAMBA на отдельном сервере (должен быть присоединён к домену):
	[global]
	allow trusted domains = no
	client signing = auto
	server signing = mandatory
	dns proxy = no
	encrypt passwords = true
	host msdfs = no
	security = user
	log file = /var/log/samba/samba_audit.log
	log level = 1 vfs:1
	full_audit:prefix = %u|%I|%S
	full_audit:success = connect, open, mkdir, rmdir, unlink, write, rename
	full_audit:failure = none
	vfs objects = full_audit
	max log size = 10240
	passdb backend = tdbsam
	realm = mil.ru
	server string = ALD CIFS file server
	workgroup = домен.ru
	unix extensions = yes
	unix password sync = no
	kerberos method = dedicated keytab
	dedicated keytab file = /etc/krb5.keytab
	disable netbios = no
	load printers = no
	socket options = TCP_NODELAY SO_KEEPALIVE
	utmp = yes

	[shared]
	comment = Share for users
	path = /DATA/samba
	available = yes
	case sensitive = yes
	fstype = Samba
	writable = yes
	smb encrypt = auto
	read only = no
	guest ok = yes
	browsable = yes
	create mask = 0660
	force create mode = 0660
	directory mask = 0770
	force directory mode = 0770
	#valid users = "@Domain Users"
	#read list = "@Domain Users"
	write list = @group_1,@group_3,@group_4
sudo systemctl restart smbd.service nmbd.service		И перезапустим файловый сервер. Теперь с помощью утилиты управления доменом введём пользователей, которые будут использовать данный сервис, в группу fuse.


================ Настройка автоматического подключения к файловому сервису ======================================================================
Чтобы на клиентских машинах была возможность автоматически подключаться к файлообменному серверу, который мы настроили ранее выполним следующие действия:
sudo apt install libpam-mount					установим пакет libpam-mount (модуль PAM — отвечает за автоматическое монтирование разделов)
PAM								Pluggable Authentication Modules
/etc/security/pam_mount.conf.xml				внесём изменения в файл , добавив в секцию следующие данные:
<volume fstype="cifs" uid="2500-65000" server="srvN.домен.ru" path="shared" mountpoint="/shared" options="user=%(USER),rw,setuids,perm,soft,sec=krb5i,cruid=%(USERUID),uid=%(USERUID),iocharset=utf8"/>
где:
srvN.домен.ru 							файлообменный сервер.
mkdir /shared							создадим каталог /shared


================ Инструменты резервного копирования ============================================================================================
Инструменты резервного копирования, входящие в состав дистрибутивов ОС Astra Linux позволяют выполнять резервное копирование и восстанавливать с сохранением все расширенные атрибуты, в том числе с сохранением мандатных меток. Есть несколько видов инструментов резервного копирования:
dd
tar
rsync


================ Инструмент командной строки dd ================================================================================================
Инструмент командной строки dd — самое простое средство полного резервного копирования. Он устанавливается автоматически и не требует дополнительных настроек. Однако в этом инструменте есть ряд недостатков, а именно:
-	при копировании незанятого пространства увеличивается число избыточных данных (недостаток);
-	необходимо размещать копии на отличном от копируемого физическом устройстве (недостаток);
-	необходимо привлекать дополнительные средства для копирования по сети (недостаток).
+ 	удобна для полного копирования дисков или дисковых разделов при переносе системы на новый диск (удобство).
sudo dd if=/dev/sda1 of=/media/not-sda1-device/sda1.bin bs=4096 	чтобы копировать системный раздел диска. 
/media/not-sda-device/sda.bin						условное название (при установке ОС с параметрами по умолчанию это /dev/sda1)
Значение параметров:
if=		— имя входного файла (если пропущено, читает стандартный ввод);
of=		— имя выходного файла (если пропущено, пишет в стандартный вывод);
bs=		— размер блока (увеличение размера блока может повысить скорость копирования). Можно выбрать размер блока равный или кратный размеру блока копируемого устройства.
sudo tune2fs -l /dev/sda1 | grep Block					узнать размер блока дискового устройства с файловой системой Ext2/Ext3/Ext4.
dd if=/dev/sda1 bs=4096 | gzip > /media/not-sda1-device/sda1.bin.gz2	для копирования алгоритмы сжатия или защитного преобразования:
dd if=/media/mountpoint/sda1.bin of=/dev/sda1 bs=4096			чтобы восстановить системный раздел диска.
gzip -dc /media/not-sda1-device/sda1.bin.gz2 | dd of=/dev/sda1 bs=4096	чтобы восстановить системный раздел диска для сжатого файла.
Важно!
Потребуется загрузиться с отдельного диска и примонтировать носитель, на котором был размещен файл с образом. 
mount -o loop /media/mountpoint/sda1.bin /mnt				полученный с помощью инструмента dd файл с образом дискового раздела (не подвергнутый сжатию или защитному преобразованию) можно примонтировать и использовать как обычный дисковый раздел.


===================== Инструмент командной строки tar ===========================================================================================
Инструмент командной строки tar в основном применяется для копирования данных в пределах одного компьютера. Он позволяет скопировать дерево файлов в один файл архива, а также сжать копии с помощью программ архивации. Для копирования через сеть требуется применение дополнительных средств.
Команды для копирования файлов в архив с условным названием /backup.tar.bz2  (файл архива располагается в той же файловой системе):
cd /sudo tar --xattrs --acls -czf backup.tar.bz2 --exclude=/proc --exclude=/lost+found --exclude=/backup.tar.bz2 --exclude=/mnt --exclude=/sys --exclude=/parsecfs /
https://s3-lms.t1.ru/files/material_images/7f8fa038d8c3bc07ab2d7c9fff250ba340eb0b3b.jpg
При копировании полные имена файлов сохраняются в архиве без начального символа /.  Это сделано из соображений безопасности, чтобы случайное или ошибочное разархивирование не перезаписало корневую файловую систему, а также чтобы файлы можно было восстанавливать из другого экземпляра ОС (например, загрузившись с LiveCD) на примонтированные устройства.
С архивами tar позволяет работать инструмент Midnight Commander, который автоматически устанавливается вместе со всеми версиями Astra Linux.
Инструмент tar не содержит собственных средств для сетевой работы, однако используется совместно с другими сетевыми инструментами. Самый безопасный из них — SSH.
tar -cvpz / | ssh 192.168.32.97 "( cat > ssh_backup.tar.gz )"		создать архив на удалённом компьютере.
Инструмент tar применяется без указания целевого файла и выводит поток данных в стандартный вывод (stdout). Стандартный вывод перенаправляется в ssh, а ssh подключается к удалённому компьютеру и выполняет на нём команду записи в файл. Примеры команд для восстановления файлов из архива:
sudo sh -c 'echo 1 > /parsecfs/unsecure_setxattr'sudo /usr/sbin/execaps -c 0x1000 -- tar --xattrs --xattrs-include=security.{PDPL,AUDIT,DEF_AUDIT} --acls -xzf backup.tar.bz2 -С /sudo sh -c 'echo 0 > /parsecfs/unsecure_setxattr'
https://s3-lms.t1.ru/files/material_images/0604dd1e2bbe005154817c560d4fcff4724d1a42.jpg
https://s3-lms.t1.ru/files/material_images/5d86724b45f51c19de3cd12b872ed9ad21ea7d28.jpg
Если восстанавливаете файлы из архива не в том экземпляре ОС, в котором они архивировались (например, восстановление производится из ОС, загруженной с LiveCD), используйте дополнительную опцию:
--numeric-owner								запрещающую перепроверять имена пользователей или групп и изменять их числовые идентификаторы в соответствии с действующим в используемой системе. После переноса с помощью tar содержимого загрузочного диска на другой диск требуется восстановить системный загрузчик grub. Для этого следует:
    1. примонтировать восстанавливаемый диск (например, в каталог /mnt);
    2. выполнить следующие команды, указав при выполнении команды dpkg-reconfigure grub-pc диск, с которого должна выполняться загрузка:
sudo -sfor f in dev dev/pts proc ; do mount --bind /$f /mnt/$f ; donechroot /mnt
cat ssh_backup.tar.gz | ssh 10.0.2.2 "tar -xvpzf - -C /tmp"		разархивирование на удалённую машину, если восстанавливаем по ssh.



===================== Инструмент командной строки rsync ==================================================================================
Работа с мандатным уровнем доступа rsync. Пример для удалённого копирования с помощью инструмента rsync:
sudo rsync -a --X --A --exclude=/proc --exclude=/lost+found --exclude=/mnt --exclude=/sys --exclude=/parsecfs --rsync-path="sudo /rsync --fake-super" /admin@host.astradomain.ru:backup
--xattrs	атрибут в краткой форме -X
--acls 		атрибут в краткой форме -A
--rsync-path	переопределяет вызов удалённого экземпляра rsync как: 
rsync 		вызов от имени и с правами суперпользователя (sudo), позволяет выставлять на удалённом компьютере любые атрибуты создаваемым файлам-копиям;
--fake-super	параметр, разрешающим выставлять создаваемым файлам-копиям атрибуты исходных файлов независимо от валидности этих атрибутов в целевой ОС.



===================== Запуск служб на мандатном уровне доступа ===========================================================================
sudo systemctl edit <имя_службы>.service		запуск служб с определённой ненулевой меткой безопасности следует назначить службе эту метку (например vsftpd). В открывшемся текстовом редакторе в секции [Service] указать нужную метку (например, для задания уровня безопасности равным 1 и с высшим уровнем конфиденциальности):
	[Service]
	PDPLabel=1:63:0
PDPLabel=<Уровень>:<Уровень целостности>:<Категории>	формат метки. Формат метки PDPLabel аналогичен принятому в системе PARSEC (рассматривали в 21-м модуле) за исключением поля типа «метки».
sudo systemctl restart <имя_службы>.service		сохранить изменения и перезапустить службу.
sudo mcedit /lib/systemd/system/vsftpd.service		
	[Service]
	PDPLabel=1:63:0
sudo systemctl daemon-reload 				после изменения сервиса
sudo systemctl restart <имя_службы>.service		



===================== !!!!!!!!!!!!!!!!!!!!!!!! Для полностью корректной работы приведённых примеров под ОС СН Смоленск, необходимо настроить политику предоставления мандатной привилегии PARSEC_CAP_UNSAFE_SETXATTR удалённому экземпляру rsync =========================================================================


