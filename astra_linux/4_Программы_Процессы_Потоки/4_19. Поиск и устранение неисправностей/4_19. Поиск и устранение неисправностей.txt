План урока
Методология поиска и устранения неисправностей.
Решение проблем, связанных с нештатными и аварийными перезагрузками системы.
Устранение неисправностей, возникающих на начальных стадиях загрузки системы.
Решение проблемы с драйверами устройства.
Устранение неисправностей, возникающих на заключительных стадиях загрузки системы.
Практическое задание.



====================== Методология поиска и устранения неисправностей =======================================================================
---------------------- 1. Выявление проблемы
Для начала следует определить, что именно не работает. Для этого используйте набор диагностических утилит:
ping, traceroute, netstat, ss;			- диагностические утилиты
systemd-journal, journalctl, dmesg;		- утилиты работы с журналами
top, iostat, vmstat.				- утилиты проверки нагрузки.

---------------------- 2. Идентификация причины
После того как проблема выявлена, необходимо определить её причины. Для этого используйте утилиты для мониторинга производительности:
sar, collectl;					- утилиты для мониторинга производительности
tcpdump;					- утилита трассировки сетевых пакетов 
grep, awk;					- анализ журналов
lsof, strace, gdb.				- дополнительные утилиты: 

---------------------- 3. Разработка и исполнение плана действий
настройка конфигурационных файлов;
замена компонентов;
патчинг или обновление системы.

---------------------- 4. Проверка исправления
Необходимо убедиться в эффективности действий. 
Для этого используйте утилиты проверки статуса процессов (systemctl status), опросите сервер или сервис через клиента, произведите повторный запуск.
Примеры команд, используемые при поиске и устранении неисправностей в Linux:
---------------------- 4.1. Проверка сетевой связи. 
Для проверки связи между хостами используйте команды ping, traceroute или mtr. 
ping -c3 8.8.8.8		- для проверки связи с хостом 8.8.8.8

---------------------- 4.2. Просмотр сетевых соединений. 
Для просмотра активных сетевых соединений используйте команду netstat.      
netstat -anv | grep tcp		- для просмотра активных TCP соединений

---------------------- 4.3. Проверка свободного места на диске. 
Для проверки свободного места на диске используйте команду df. 
df -h /				- проверки свободного места на корневом разделе

---------------------- 4.4. Проверка журналов. 
Для проверки журналов событий используйте команду journalctl.
journalctl -n50			- просмотра последних 50 записей журнала

---------------------- 4.5. Проверка процессов. 
Для проверки работающих процессов используйте команду ps.
ps aux | grep username		- просмотра списка работающих процессов пользователя

---------------------- 4.6. Проверка файловой системы. 
Для проверки файловой системы используйте утилиту fsck.
sudo fsck /dev/sda1		- проверки корневого раздела

---------------------- 4.7. Анализ логов. 
Для анализа лог-файлов используйте утилиту grep. 
grep "error" /var/log/syslog	- поиска всех записей в лог-файле, содержащих слово error


====================== Решение проблем, связанных с нештатными и аварийными перезагрузками системы =====================================================
			Чтобы решить проблему с нештатными и аварийными перезагрузками системы Astra Linux, проанализируйте журналы системных сообщений после перезагрузки. Это позволит определить причину неполадок и внести соответствующие изменения в настройки системы. Например, если причина перезагрузки — переполнение логического тома корневой файловой системы, увеличьте размер этого тома или удалите ненужные файлы, чтобы освободить место. Чтобы предотвращать аварийные перезагрузки, регулярно обновляйте систему и проверяйте, нет ли ошибок и предупреждений в системном журнале.
Меры предотвращения нештатной перезагрузки Astra Linux:
---------------------- 1. Проверка аппаратного обеспечения.  
			Нештатные перезагрузки бывают связаны с неисправностью аппаратного обеспечения, поэтому необходимо регулярно проверять его состояние и работоспособность. Для этого используйте специализированные утилиты (smartctl), которые диагностируют состояние жёстких дисков и других устройств хранения данных.

---------------------- 2. Удаление ненужного софта.  
			Избыточное количество устанавливаемого софта и сервисов приводит к нештатным перегрузкам системы. Поэтому необходимо удалить ненужное ПО и отключить неиспользуемые сервисы.

---------------------- 3. Мониторинг системных ресурсов.   
			Необходимо следить за загрузкой системы и работой процессов. Для этого используйте утилиты мониторинга htop, netstat, которые показывают текущую нагрузку на систему и количество задействованных сетевых ресурсов.

---------------------- 4. Резервное копирование данных.  
			Перед выполнением операций, которые могут привести к нештатной перезагрузке, создайте резервную копию важных данных. Это позволит восстановить систему после аварийной перезагрузки.

Если к перезагрузке привело некорректное отключение электропитания, используйте источники бесперебойного питания (UPS). Они обеспечивают непрерывную работу системы при кратковременных провалах электропитания. 

---------------------- Утилиты и инструменты. Способы  -------------------------------------------------------------------------------------------------------------------- 
apcupsd			- программное обеспечение apcupsd позволяет контролировать источники бесперебойного питания. Оно сразу отправит оповещение, если есть неисправность.
fsck			- утилита Linux проверяет и исправляет ошибки в файловых системах при нештатной перезагрузке. Эта утилита по умолчанию входит в состав дистрибутивов Linux.
GRUB			- загрузчик. Инструмент позволяет выбрать режим загрузки системы и восстановить настройки.
Прежде чем использовать эти инструменты, необходимо создать резервную копию данных, чтобы при необходимости восстановить систему. В целом для предотвращения нештатных и аварийных перезагрузок рекомендуется:
1) регулярно обновлять систему; 
2) устранять ошибки и предупреждения в системном журнале; 
3) проверять аппаратное обеспечение;
4) использовать специализированные утилиты:
htop 			— утилита для мониторинга загрузки системы и работы процессов в режиме реального времени;
netstat 		— утилита для мониторинга сетевых ресурсов и отслеживания сетевых соединений.
blkid			- команда в Linux, которая отображает информацию о блочных устройствах (жёстких дисках, твердотельных накопителях, USB-накопителях). Она выводит атрибуты устройств: UUID (универсальный уникальный идентификатор), тип файловой системы, метки и другие
init 6			- команда в операционной системе Linux, которая инициирует перезагрузку системы (уровень выполнения 6). Это часть команды init, которая управляет режимами работы системы через уровни выполнения (runlevel) sudo init 6
lvdisplay		- — команда, которая отображает подробную информацию о логических томах (LVM)

====================== Устранение неисправностей, возникающих - на начальных стадиях загрузки системы загрузчик GRUB ============================================================
			вложен скрин "Проблемы на начальных стадиях загрузки системы"
Запуск Linux в однопользовательском (single mode) режиме:
В меню GRUB нажимаем «e» (редактирование команд загрузки). Найти строку, начинающуюся с linux и в конце припишите параметр single, после чего нажмите Ctrl-x.


====================== Устранение неисправностей, возникающих - с драйверами устройства загрузчик GRUB ================================================================================================
После того как вы нашли проблемный модуль или драйвер ядра, загружаемся в однопользовательском (single mode) режиме:
1.    В меню GRUB нажимаем «e» (редактирование команд загрузки).
2.    Вводим логин и пароль администратора системы. Вы задавали его при установке системы во втором модуле, либо работаете под ним.
3.    Находим и редактируем строчку linux /vmlinuz-5: вместо ro пишем rw init=/bin/bash и стираем слово quiet (тихий режим).
4.    Нажимаем Ctrl + x или F10.
Система начала загружаться.
root		управлять/редактировать файлы FHS от имени root, отредактировать, почистить проблемный драйвер устройства или модуль ядра, который не грузится; посмотреть логи.
fsck 		(File System Consistency Check). Проверка системы, если она не грузится. 
fsck		команда в Linux, которая проверяет и, по возможности, чинит файловые системы (ФС). Работает почти со всеми популярными ФС: ext2/3/4, XFS, Btrfs, ReiserFS, JFS и т. д.. Как работает: fsck проходит по метаданным файловой системы (суперблоки, индексы, таблицы inodes и т. д.), сверяет их между собой и с реальным содержимым, ищет несоответствия и предлагает их исправить. Если всё плохо, может даже восстановить потерянные файлы или каталоги (или хотя бы их куски). Синтаксис: Базовый синтаксис: fsck <options> <filesystem>. Файловой системой может быть устройство, раздел, точка монтирования и так далее. Важно: перед проверкой необходимо размонтировать проверяемое устройство. Если файловая система не указана в качестве аргумента, fsck проверяет устройства, перечисленные в файле fstab, а также в GRUB редактируем строчку linux /vmlinuz-5: в режиме ro init=/bin/bash, чтобы монтировалась.	
passwd		изменить пароль passwd, назначить новый

====================== Устранение неисправностей, возникающих если система не загружается из-за проблем с загрузчиком GRUB. "Режим восстановления" - "recovery mode" ===============================
			отсутствие доступов к оборудованию, для успешной загрузки системы (мышь, клавиатура);
			недоступность Жёсткого диска (не виден, не распознаётся системой);
Нужен загрузочный диск или USB-накопитель и восстановить загрузчик.
Для этого остановите загрузку GRUB и загрузитесь с помощью Live-Astra-Linux-дистрибутива, который вы можете записать на USB-носитель или DVD-диск (Live CD, который должен быть предварительно подготовлен).
1.  Загрузите вашу машину с "Live CD" - Live Astra Linux-дистрибутива. На VM VirtualBox в разделе "Настроить","Система" поместить "Оптический диск" в начало списка (первую очередь);
2.  Войдите в Live Astra Linux-среду "Режим восстановления" - "recovery mode".
3.  Откройте терминал.
4.  Введите следующую команду: sudo fdisk -l
5.  Посмотрите таблицу разделов. Она должна содержать следующий раздел: /dev/sda1 * ....... Linux. Это раздел, который хранит вашу операционную систему.
6.  Следующим шагом будет монтирование раздела /dev/sda1. Для этого необходимо выполнить команду: sudo mount /dev/sda1 /mnt
6.1. Примонтировать UUID в /etc/fstab
7.  Далее, после монтирования, нужно переключиться в среду установленной ОС. Для этого введите следующую команду: sudo chroot /mnt.
8.  Теперь вы имеете доступ к вашей установленной ОС и можете выполнить необходимые действия, например, переустановить GRUB с помощью команды sudo grub-install --recheck /dev/sda. Если необходимо обновить ядро, то можно воспользоваться командой sudo apt-get install linux-image.
9.  После выполнения всех необходимых действий, выйдите из chroot командой exit и перезагрузите ПК с помощью команды sudo reboot.
В случае ошибки kernel panic при загрузке Linux, которая может возникнуть из-за проблем с ядром Linux, файловой системой или аппаратными проблемами, попробуйте загрузить систему в режиме восстановления или однопользовательском режиме и провести диагностику системы, используя утилиты fsck, dmesg, lspci, lsusb и другие, чтобы выявить и исправить возможные проблемы. Если это не помогает, попытайтесь установить новую копию системы, переустановить ядро или осуществить другие действия.
Ещё одной проблемой на начальной стадии загрузки Linux может быть отсутствие доступа к оборудованию компьютера, необходимому для успешной загрузки системы.
Например, если жёсткий диск не подключён или не распознается BIOS/UEFI, то загрузка системы Astra Linux может быть невозможна. В этом случае необходимо убедиться в правильности подключения всех необходимых компонентов и настроек BIOS/UEFI, а также проверить работоспособность оборудования с помощью специальных утилит, таких как memtest86+ (для проверки оперативной памяти) или smartmontools (для проверки жёсткого диска).



====================== Устранение неисправностей, возникающих - на заключительных стадиях загрузки системы =========================================================
При возникновении проблем на заключительных стадиях загрузки системы Astra Linux проведите следующие действия для их устранения:
1.    Загрузите в однопользовательском режиме (single mode).
2.    Проверьте журналы Astra Linux (логи), используя команду journalctl. Она позволяет просмотреть все события и сообщения, которые происходят в системе на этапе загрузки.
3.    Проверьте таблицу разделов при помощи команды fdisk -l, чтобы убедиться, что разделы смонтированы корректно и на них достаточно места.
4.    Проверьте файл /etc/fstab на наличие ошибок в конфигурации монтирования.
5.    Убедитесь в наличии свободного места на диске, используя команду df.
6.    Проверьте целостность файловой системы при помощи команды fsck.
7.    Если проблема возникает при загрузке графического интерфейса (X11), попробуйте загрузить систему без него, используя команду systemctl restart fly-dm.
Если причина проблемы в загрузке ядра, можно попробовать загрузить более старую версию ядра (если она установлена).

